#-------------------------------------------------------------------------------------------------#
# File:    .gitlab/ci/msvc-jobs.yml
# Author:  Kelly Thompson <kgt@lanl.gov>
# Date:    Monday, Jun 01, 2020, 15:00 pm
# Purpose: gitlab suid runner commands for MSVC (LANL). This script wil be run to test pull
#          requests
# Note:    Copyright (C) 2021 Triad National Security, LLC., All rights reserved.
#-------------------------------------------------------------------------------------------------#

# Setup a "Group Runner" on gitlab.
# 1. The Group owner must navigate to https://gitlab.lanl.gov/groups/jayenne/-/settings/ci_cd and
#    obtain a token
# 2. On the Windows machine use an elevated administrator command prompt to
#    a. install gitlab-runner
#       gitlab-runner.exe stop
#    b. gitlab-runner.exe register
#       gitlab-ci coordinator URL https://gitlab.lanl.gov/
#       gitlab-ci token for this runner: <token>
#       gitlab-ci description for this runner: Win64-MSVC2019
#       gitlab-ci tags for this runner: win64-msvc2019-shell
#       executor: shell
#    c. gitlab-runner.exe start

#-------------------------------------------------------------------------------------------------#
# Machine-wide default job settings
#-------------------------------------------------------------------------------------------------#

---
.msvc22:
  tags:
    - win64-msvc2019-shell
  variables:
    DRACO_BINARY_DIR: ${CI_PROJECT_DIR}\build
    SITE_ID: Win10
    GENERATOR: "Visual Studio 17 2022"
    DEPLOY: "FALSE"
    VCVARS: "C:\\PROGRA~1\\MIB055~1\\2022\\Community\\VC\\Auxiliary\\Build\\vcvars64.bat"
    CMAKE_TOOLCHAIN_FILE: "${CI_PROJECT_DIR}\\.gitlab\\ci\\vs2022-toolchain.cmake"
    MINGW64PATH: "C:\\msys64\\mingw64\\bin"
    CMAKE_C_FLAGS: "/WX"
    CMAKE_Fortran_FLAGS: "-Werror"
  artifacts:
    paths:
      - ${CI_PROJECT_DIR}/glr.log

#-------------------------------------------------------------------------------------------------#
# Build Templates
#-------------------------------------------------------------------------------------------------#

.msvc_merge:
  extends: .msvc22
  variables:
    CTEST_MODE: Experimental
  script:
    #- git.exe config --global --unset http.proxy
    #- git.exe config --global --unset https.proxy
    - cmd.exe /c "%CI_PROJECT_DIR%\.gitlab\ci\gitlab-ci-run-tests.bat"
  rules:
    - if: '$CI_MERGE_REQUEST_LABELS =~ /exclude_msvc/'
      when: never
    - if: '$CI_MERGE_REQUEST_TITLE =~ /Draft:/ || $CI_MERGE_REQUEST_TITLE =~ /WIP:/'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

#.msvc_nightly:
#  extends: .msvc
#  variables:
#    CTEST_MODE: Nightly
#    CTEST_BUILD_NAME: ${COMPILER}-${CMAKE_BUILD_TYPE}
#  script:
#    - cmd.exe /c "%CI_PROJECT_DIR%\.gitlab\ci\gitlab-nightly-regress.bat"
#  only:
#    - schedules

#-------------------------------------------------------------------------------------------------#
# Merge Requests
#-------------------------------------------------------------------------------------------------#

x64_deb_msvc_22_mr:
  stage: slowtest
  extends: .msvc_merge
  variables:
    CMAKE_BUILD_TYPE: Debug
    COMPILER: msvc-2022
  allow_failure: true

#-------------------------------------------------------------------------------------------------#
# Nightly Regression
#-------------------------------------------------------------------------------------------------#

#x86_deb_msvc_19_regress:
#  stage: test
#  extends: .msvc_nightly
#  variables:
#    CMAKE_BUILD_TYPE: Debug
#    COMPILER: msvc-2019
# for now, these options are set in csk-nightly.cmake
#    EXTRA_CMAKE_ARGS: -G"Visual Studio 16 2019" -A x64
#       -DCMAKE_TOOLCHAIN_FILE="%CMAKE_TOOLCHAIN_FILE%" -DCSK_LIBRARY_TYPE=SHARED
#    SCHEDULER_PARAMETERS: ${SP_x86_64}

#-------------------------------------------------------------------------------------------------#
# end .gitlab/ci/nmsvc-jobs.yml
#-------------------------------------------------------------------------------------------------#
