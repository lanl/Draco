#--------------------------------------------------------------------------------------------------#
# File:    .gitlab/ci/docker-jobs.yml
# Author:  Kelly Thompson <kgt@lanl.gov>
# Date:    Wednesday, Jan 13, 2021, 20:57 pm
# Purpose: gitlab suid runner commands for superlinter (https://github.com/github/super-linter).
# Note:    Copyright (C) 2020-2023 Triad National Security, LLC., All rights reserved.
#
# See Also: https://gitlab.com/snippets/1988376
#--------------------------------------------------------------------------------------------------#

---
superlinter:
  tags:
    - darwin-docker-shared
  stage: lint
  image:
      name: github/super-linter:slim-v4
  script: ["true"]
  rules:
    - if: '$CI_MERGE_REQUEST_LABELS =~ /exclude_darwin/'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
  variables:
    RUN_LOCAL: "true"
    DEFAULT_WORKSPACE: $CI_PROJECT_DIR
    ANSIBLE_DIRECTORY: $CI_PROJECT_PATH
    LINTER_RULES_PATH: $CI_PROJECT_PATH/.github/linters
    DEFAULT_BRANCH: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME
    ERROR_ON_MISSING_EXEC_BIT: "true"
    FILTER_REGEX_EXCLUDE: (.*[.]cc$|/test/)
    PYTHON_FLAKE8_CONFIG_FILE: .flake8
    SUPPRESS_POSSUM: "true"
    LOG_LEVEL: "NOTICE"
    VALIDATE_ALL_CODEBASE: "false"
    VALIDATE_BASH: "true"
    VALIDATE_BASH_EXEC: "true"
    VALIDATE_DOCKERFILE: "true"
    VALIDATE_ENV: "true"
    VALIDATE_HTML: "true"
    VALIDATE_JSON: "true"
    # VALIDATE_LATEX: "true"
    VALIDATE_LUA: "true"
    VALIDATE_MARKDOWN: "true"
    VALIDATE_PERL: "true"
    VALIDATE_PYTHON: "true"
    VALIDATE_PYTHON_FLAKE8: "true"
    VALIDATE_POWERSHELL: "true"
    VALIDATE_RUBY: "true"
    VALIDATE_SHELL_SHFMT: "true"
    VALIDATE_XML: "true"
    # VALIDATE_YAML: "true"

checkCoverage_MR:
  # Ref: https://re-git.lanl.gov/draco/devops/-/wikis/Fail-a-CI-test-if-coverage-decreases
  # CI_API_V4_URL = https://re-git.lanl.gov/api/v4
  # CI_MERGE_REQUEST_PROJECT_ID = 503 (draco)
  # TARGET_COVERAGE_PERCENT is set in the gitlab CI variables section of the GUI.
  tags:
    - darwin-docker-shared
  stage: metrics
  allow_failure: true
  image:
    name: alpine:3.16.2
  allow_failure: true
  before_script:
    - apk add --quiet --update --no-cache curl jq
  dependencies:
    - ccs2_gcov
  variables:
    BASE_URL: "${CI_API_V4_URL}/projects/${CI_MERGE_REQUEST_PROJECT_ID}/pipelines"
    URL: "${BASE_URL}/${CI_PIPELINE_ID}/jobs?private_token=${PRIVATE_TOKEN}"
  artifacts:
    paths:
      - ${CI_JOB_NAME}.log
  script:
    - echo "curl -k -s ${URL} --> ${CI_JOB_NAME}.log"
    - curl -k -s ${URL}
    - curl -k -s ${URL} > ${CI_JOB_NAME}.log
    - CURRENT_COVERAGE=$(jq --arg JOB_NAME ccs2_gcov
      '.[] | select (.name=="ccs2_gcov") | .coverage' < "${CI_JOB_NAME}.log")
    - echo "TARGET_COVERAGE  = ${TARGET_COVERAGE_PERCENT}"
    - echo "CURRENT_COVERAGE = ${CURRENT_COVERAGE}"
    - >
      if [ "${CURRENT_COVERAGE}notset" == "notset" ]; then
        echo "==> FAIL: Error extracting coverage metric." && exit 1; fi
    - >
      if [ $(echo "${CURRENT_COVERAGE} < ${TARGET_COVERAGE_PERCENT}"|bc) == 1 ]; then
        echo -n  "==> FAIL: Code coverage for this MR is below target value of " &&
        echo "${TARGET_COVERAGE_PERCENT}" && exit 1;
      else
        echo "==> PASS: Code coverage for this MR meets minimum requirements" &&
        echo "    ${CURRENT_COVERAGE}% > ${TARGET_COVERAGE_PERCENT}%";
      fi
  rules:
    - if: '$CI_MERGE_REQUEST_LABELS =~ /exclude_ccsnet/'
      when: never
    - if: '$CI_MERGE_REQUEST_LABELS =~ /exclude_darwin/'
      when: never
    - if: '$CI_MERGE_REQUEST_TITLE =~ /Draft:/ || $CI_MERGE_REQUEST_TITLE =~ /WIP:/'
      when: never
    - if: '$CI_PROJECT_NAMESPACE != "draco"'
      when: never
    - if: '$CI_COMMIT_BRANCH == "develop"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

#--------------------------------------------------------------------------------------------------#
# Regressions: collect data from LLNL RZ systems and post it to cdash
#--------------------------------------------------------------------------------------------------#

post_rzansel_results_to_cdash:
  # https://docs.gitlab.com/ee/api/job_artifacts.html
  # CI_API_V4_URL = https://re-git.lanl.gov/api/v4
  # CI_PROJECT_ID = 503
  tags:
    - darwin-docker-shared
  stage: test
  allow_failure: true
  image:
    name: alpine:3.16.2
  before_script:
    - apk add --quiet --update --no-cache curl jq cmake
  needs:
    - rzansel_deb_xl1611_regress
    - rzansel_rel_xl1611_regress
  variables:
    BASE_URL: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}"
    URL: "${BASE_URL}/pipelines/${CI_PIPELINE_ID}/jobs?private_token=${PRIVATE_TOKEN}"
    URL2: "${BASE_URL}/jobs/${JID}/artifacts?private_token=${PRIVATE_TOKEN}"
  script:
    - mkdir -p ${DRACO_BINARY_DIR} && cd ${DRACO_BINARY_DIR}
    - echo " CI_API_V4_URL = ${CI_API_V4_URL}"
    - echo "CI_PIPELINE_ID = ${CI_PIPELINE_ID}"
    # Get all of the meta data for this pipeline.
    - echo "curl -k -s ${URL} --> ${CI_JOB_NAME}.log"
    - curl -k -s ${URL}
    - curl -k -s ${URL} > ${CI_JOB_NAME}.log
    # Find the job ID for the job of interest and unload its artifacts.
    - JID=$(cat ${CI_JOB_NAME}.log | jq -c '.[] | select (.name == "rzansel_deb_xl1611_regress") | .id')
    - echo "Downlowding artifacts for JID=${JID}..."
    - curl --location --output artifacts.zip ${URL2}
    - ls -aFl
    # - mkdir rzansel_deb_xl1611_regress && cd rzansel_deb_xl1611_regress
    # - unzip artifacts.zip
    # - ls -aFl
    # Process the CDash data and upload it.
    #
    # Update the DartConfigration.tcl file so that it makes sense.
    # - sed -i "s%SourceDirectory.*%SourceDirectory: /usr/projects/ccsrad/regress/${project}%" DartConfiguration.tcl
    # - sed -i "s%BuildDirectory.*%BuildDirectory: /usr/projects/ccsrad/regress/rzansel_staging/${build_dir}%" DartConfiguration.tcl
    # - tag=`head -n 1 Testing/TAG`
    # - buildname=`grep BuildName Testing/${tag}/Build.xml | sed -e s'/.*\"\(.*\)\"/\1/'`
    # - sed -i "s%BuildName.*%BuildName: ${buildname}%" DartConfiguration.tcl
    # - sed -i "s%Site.*%Site: rzvernal-gr%" DartConfiguration.tcl
    # - echo -e "\n-- Modified values:\n"
    # - grep Site DartConfiguration.tcl
    # - grep BuildName DartConfiguration.tcl
    # - which ctest
    # - ctest --extra-submit DartConfiguration.tcl
    # - cd /usr/projects/ccsrad/regress/rzansel_staging
    # - rm ${tf}"
    # - rm -rf ${build_dir}"
    #
    #   if [ "${CURRENT_COVERAGE}notset" == "notset" ]; then
    #     echo "==> FAIL: Error extracting coverage metric." && exit 1; fi
    # - >
    #   if [ $(echo "${CURRENT_COVERAGE} < ${TARGET_COVERAGE_PERCENT}"|bc) == 1 ]; then
    #     echo -n  "==> FAIL: Code coverage for this MR is below target value of " &&
    #     echo "${TARGET_COVERAGE_PERCENT}" && exit 1;
    #   else
    #     echo "==> PASS: Code coverage for this MR meets minimum requirements" &&
    #     echo "    ${CURRENT_COVERAGE}% > ${TARGET_COVERAGE_PERCENT}%";
    #   fi
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'

#--------------------------------------------------------------------------------------------------#
# end .gitlab/ci/docker-jobs.yml
#--------------------------------------------------------------------------------------------------#
