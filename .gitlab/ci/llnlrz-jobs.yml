#--------------------------------------------------------------------------------------------------#
# File:    .gitlab/ci/llnlrz-jobs.yml
# Author:  Kelly Thompson <kgt@lanl.gov>
# Date:    Mon Feb 27 14:41:34 MST 2023
# Purpose: gitlab jacamar runner commands for LLNL RZ systems.
# Note:    Copyright (C) 2023 Triad National Security, LLC., All rights reserved.
#--------------------------------------------------------------------------------------------------#

#--------------------------------------------------------------------------------------------------#
# Machine-wide default job settings
#--------------------------------------------------------------------------------------------------#

---
.rzvernal:
  tags:
    - rzvernal
    - batch
  variables:
    CTEST_MODE: Experimental
    DEPLOY: "FALSE"
    SITE_ID: rzvernal
    CTEST_NPROC: 40
    SCHEDULER_PARAMETERS: -N 1
    LLNL_SLURM_SCHEDULER_PARAMETERS: -N 1

.rzansel:
  tags:
    - rzansel
    - batch
  variables:
    CTEST_MODE: Experimental
    DEPLOY: "FALSE"
    SITE_ID: rzansel
    CTEST_NPROC: 10
    # SCHEDULER_PARAMETERS: -N 1
    # LLNL_SLURM_SCHEDULER_PARAMETERS: -N 1

#--------------------------------------------------------------------------------------------------#
# Merge Requests
#--------------------------------------------------------------------------------------------------#

.rzvernal_merge:
  extends: .rzvernal
  allow_failure: true
  script:
    - /bin/bash -l -c "${CI_PROJECT_DIR}/.gitlab/ci/gitlab-ci-run-tests.sh"
  rules:
    - if: '$CI_MERGE_REQUEST_LABELS =~ /exclude_rzvernal/'
      when: never
    - if: '$CI_MERGE_REQUEST_TITLE =~ /Draft:/ || $CI_MERGE_REQUEST_TITLE =~ /WIP:/'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

.rzansel_merge:
  extends: .rzansel
  allow_failure: true
  script:
    - /bin/bash -l -c "${CI_PROJECT_DIR}/.gitlab/ci/gitlab-ci-run-tests.sh"
  rules:
    - if: '$CI_MERGE_REQUEST_LABELS =~ /exclude_rzansel/'
      when: never
    - if: '$CI_MERGE_REQUEST_TITLE =~ /Draft:/ || $CI_MERGE_REQUEST_TITLE =~ /WIP:/'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

# ----- regular test -----

rzvernal_rel_cce1501_mr:
  stage: test
  extends: .rzvernal_merge
  variables:
    CMAKE_BUILD_TYPE: Debug
    DRACO_ENV: "lapse/2.2.0-cce"
    EXTRA_CMAKE_ARGS: -GNinja -DUSE_GPU=OFF
    # DRACO_ENV: "lapse/2.2.0-cce-hip"

rzansel_rel_xl1611_mr:
  stage: test
  extends: .rzansel_merge
  variables:
    CMAKE_BUILD_TYPE: Debug
    DRACO_ENV: "lapse/2.2.0-xl"

#--------------------------------------------------------------------------------------------------#
# end .gitlab/ci/lanlrz-jobs.yml
#--------------------------------------------------------------------------------------------------#
