#--------------------------------------------------------------------------------------------------#
# File:    .gitlab/ci/tt-jobs.yml
# Author:  Kelly Thompson <kgt@lanl.gov>
# Date:    Thursday, Dec 02, 2021, 09:36 am
# Purpose: gitlab jacamar runner commands for Trinitite (LANL HPC).
# Note:    Copyright (C) 2022 Triad National Security, LLC., All rights reserved.
#--------------------------------------------------------------------------------------------------#

#--------------------------------------------------------------------------------------------------#
# Machine-wide default job settings
#--------------------------------------------------------------------------------------------------#

.tt:
  tags:
    - trinitite
  variables:
    CTEST_MODE: Experimental
    DEPLOY: "FALSE"
    SITE_ID: trinitite
    SCHEDULER_PARAMETERS: "-N 1 --reservation=debug"
    CTEST_NPROC: 32
    # -A asc-ci --reservation=ci"
    # CI_DEBUG_TRACE: "true"

#--------------------------------------------------------------------------------------------------#
# Deployment Jobs (run on develop after MRs are merged)
#--------------------------------------------------------------------------------------------------#

# .tt_deploy:
#   extends: .tt
#   stage: deploy
#   variables:
#     DEPLOY: 'TRUE'
#     DRACO_INSTALL_DIR: "/usr/projects/draco/deploy/${FLAVOR}"
#   script:
#     - /bin/bash -l -c "${CI_PROJECT_DIR}/.gitlab/ci/gitlab-ci-run-tests.sh"
#   rules:
#     # Don't deploy if this is a forked repository.
#     - if: '$CI_PROJECT_NAMESPACE != "draco"'
#       when: never
#     - if: '$CI_PIPELINE_SOURCE == "schedule"'
#       when: never
#     - if: '$CI_COMMIT_BRANCH == "develop"'
#     - if: '$CI_PIPELINE_SOURCE == "web"'

# tt_rel_i1904_deploy:
#   extends: .tt_deploy
#   variables:
#     CMAKE_BUILD_TYPE: Release
#     DRACO_ENV: "lapse/1.8-intel"
#     FLAVOR: lapse18-intel-Release

# tt_deb_i1904_deploy:
#   extends: .tt_deploy
#   variables:
#     CMAKE_BUILD_TYPE: Debug
#     DRACO_ENV: "lapse/1.8-intel"
#     FLAVOR: lapse18-intel-Debug

# tt_rel_i1913_deploy:
#   extends: .tt_deploy
#   variables:
#     CMAKE_BUILD_TYPE: Release
#     DRACO_ENV: "draco/intel1913"
#     FLAVOR: intel1913-Release

# tt_deb_g930_deploy:
#   extends: .tt_deploy
#   variables:
#     CMAKE_BUILD_TYPE: Debug
#     DRACO_ENV: "lapse/1.8-gnu"
#     FLAVOR: lapse18-gnu-Debug

# tt_rel_g930_deploy:
#   extends: .tt_deploy
#   variables:
#     CMAKE_BUILD_TYPE: Release
#     DRACO_ENV: "lapse/1.8-gnu"
#     FLAVOR: lapse18-gnu-Release

# tt_deb_fulldiag_deploy:
#   extends: .tt_deploy
#   variables:
#     CMAKE_BUILD_TYPE: Debug
#     DRACO_ENV: "lapse/1.8-intel"
#     EXTRA_CMAKE_ARGS: -DDRACO_DIAGNOSTICS=7 -DDRACO_TIMING=1 -DDRACO_LIBRARY_TYPE=STATIC
#     FLAVOR: intel-fulldiag-static

#--------------------------------------------------------------------------------------------------#
# Merge Requests
#--------------------------------------------------------------------------------------------------#

.tt_merge:
  extends: .tt
  # allow_failure: true
  script:
    - /bin/bash -l -c "${CI_PROJECT_DIR}/.gitlab/ci/gitlab-ci-run-tests.sh"
  rules:
    - if: '$CI_MERGE_REQUEST_LABELS =~ /exclude_trinitite/'
      when: never
    - if: '$CI_MERGE_REQUEST_TITLE =~ /Draft:/'
      when: never
    - if: '$CI_MERGE_REQUEST_TITLE =~ /WIP:/'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

# ----- fast -----

# None

# ----- regular test -----

tt_rel_i1904_mr:
  stage: test
  extends: .tt_merge
  variables:
    CMAKE_BUILD_TYPE: Release
    DRACO_ENV: "lapse/1.8-intel"

# ----- slow -----

tt_deb_i1904_mr:
  stage: slowtest
  extends: .tt_merge
  variables:
    CMAKE_BUILD_TYPE: Debug
    DRACO_ENV: "lapse/1.8-intel"

tt_deb_oneapi_mr:
  stage: slowtest
  extends: .tt_merge
  variables:
    CMAKE_BUILD_TYPE: Debug
    DRACO_ENV: "draco/oneapi2140"

tt_deb_cce_mr:
  stage: slowtest
  extends: .tt_merge
  variables:
    CMAKE_BUILD_TYPE: Debug
    DRACO_ENV: "draco/cce1101"

#--------------------------------------------------------------------------------------------------#
# Nightly Regression
#--------------------------------------------------------------------------------------------------#

# .tt_nightly:
#   extends: .tt
#   variables:
#     CTEST_MODE: Nightly
#     MAKEFILE_FLAGS: -j -l 36
#     CTEST_NPROC: 36
#   script:
#     - /bin/bash -l "${CI_PROJECT_DIR}/.gitlab/ci/gitlab-nightly-regress.sh" -m "Configure,Build,Test"
#   after_script:
#     - /bin/bash -l "${CI_PROJECT_DIR}/.gitlab/ci/gitlab-nightly-regress.sh" -m "Submit"
#   rules:
#     - if: '$CI_PIPELINE_SOURCE == "schedule"'

# tt_rel_i1904_regress:
#   stage: test
#   extends: .tt_nightly
#   variables:
#     CMAKE_BUILD_TYPE: Release
#     DRACO_ENV: "lapse/1.8-intel"
#     CTEST_BUILD_NAME: "lapse18-intel-Release"

# tt_deb_i1904_regress:
#   stage: test
#   extends: .tt_nightly
#   variables:
#     CMAKE_BUILD_TYPE: Debug
#     DRACO_ENV: "lapse/1.8-intel"
#     CTEST_BUILD_NAME: "lapse18-intel-Debug"

# tt_rel_i1913_regress:
#   extends: .tt_nightly
#   variables:
#     CMAKE_BUILD_TYPE: Release
#     DRACO_ENV: "draco/intel1913"
#     CTEST_BUILD_NAME: "intel1913-Release"

# tt_deb_g830_regress:
#   extends: .tt_nightly
#   variables:
#     CMAKE_BUILD_TYPE: Debug
#     DRACO_ENV: "lapse/1.8-gnu"
#     CTEST_BUILD_NAME: "lapse18-gnu-Debug"

# tt_deb_fulldiag_regress:
#   extends: .tt_nightly
#   variables:
#     CMAKE_BUILD_TYPE: Debug
#     DRACO_ENV: "lapse/1.8-intel"
#     FLAVOR: intel-fulldiag-static
#     EXTRA_CMAKE_ARGS: -DDRACO_DIAGNOSTICS=7 -DDRACO_TIMING=1 -DDRACO_LIBRARY_TYPE=STATIC
#     CTEST_BUILD_NAME: intel-fulldiag-static

#--------------------------------------------------------------------------------------------------#
# end .gitlab/ci/tt-jobs.yml
#--------------------------------------------------------------------------------------------------#
